name: Test the bundle
on: [push, pull_request]

jobs:
    build-and-test:
        runs-on: ubuntu-18.04
        steps:
            - name: Checkout ğŸ›ï¸
              uses: actions/checkout@v2
              with:
                  persist-credentials: false

            - name: Start docker ğŸ”§
              run: |
                  docker-compose -f docker-compose.yml -f .github/docker-compose.yml up -d

            - name: Install the dependencies ğŸ”§
              run: |
                  docker-compose exec -T application composer install --prefer-dist --no-interaction --no-progress
                  docker-compose exec -T application php -d zend_extension=xdebug.so ./bin/phpunit --configuration phpunit.xml.dist --dump-xdebug-filter phpunit-filter.php

            - name: Execute the tests ğŸ”§
              run: |
                  docker-compose exec -T application php -d zend_extension=xdebug.so ./bin/phpunit --prepend phpunit-filter.php --configuration phpunit.xml.dist --colors=never --coverage-clover build/logs/clover.xml

            - name: Upload results to Coveralls ğŸš€
              env:
                  COVERALLS_REPO_TOKEN: ${{ secrets.GITHUB_TOKEN }}
              run: |
                  composer global require twinh/php-coveralls --prefer-dist --no-interaction --no-progress
                  ~/.composer/vendor/bin/php-coveralls --coverage_clover=build/logs/clover.xml -v
