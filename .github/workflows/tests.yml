name: Test the bundle
on: [push, pull_request]

jobs:
    build-and-test:
        runs-on: ubuntu-18.04
        steps:
            - name: Checkout 🛎️
              uses: actions/checkout@v2
              with:
                  persist-credentials: false

            - name: Start docker 🔧
              run: |
                  mkdir vendor
                  docker-compose up -d

            - name: Install the dependencies 🔧
              run: |
                  docker-compose exec -T application composer install --prefer-dist --no-interaction
                  docker-compose exec -T application php -d zend_extension=xdebug.so ./bin/phpunit --configuration phpunit.xml.dist --dump-xdebug-filter phpunit-filter.php

            - name: Execute the tests 🔧
              run: |
                  docker-compose exec -T application php -d zend_extension=xdebug.so ./bin/phpunit --prepend phpunit-filter.php --configuration phpunit.xml.dist --colors=never --coverage-clover clover.xml

            - name: Upload results to Coveralls 🚀
              env:
                  COVERALLS_REPO_TOKEN: ${{ secrets.GITHUB_TOKEN }}
              run: |
                  docker-compose exec -T application composer global require twinh/php-coveralls
                  docker-compose exec -T application php-coveralls --coverage_closer=clover.xml -v
